"var T=Object.defineProperty;var b=(s,e,t)=>e in s?T(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var w=(s,e,t)=>(b(s,typeof e!=\"symbol\"?e+\"\":e,t),t);var E=(s,e)=>({value:s,transferables:e,__x_tdata__:!0});var u=-1,p=\"__x_rpc_error__\",v=\"__x_rpc_response__\",g=[],c=class{idCount;queue;actionsIndex;messageContainer;messageTarget;messageHandlerRef;state;constructor({responses:e,messageTarget:t,state:n}){let r=this;this.state=n,this.messageTarget=t,this.messageHandlerRef=o=>{r.consumeMessage(o.data,\"source\"in o&&o.source||null)},this.messageTarget.addEventListener(\"message\",r.messageHandlerRef),this.idCount=0,this.queue=[],this.messageContainer={handle:\"\",id:-1,respondingTo:u,data:null},this.actionsIndex=new Map;let a=Object.keys(e);for(let o=0;o<a.length;o++){let l=a[o];this.actionsIndex.set(l,e[l])}}cleanup(){return this.messageTarget.removeEventListener(\"message\",this.messageHandlerRef),!0}replaceMessageTarget(e){let t=this;return this.cleanup(),this.messageTarget=e,this.messageTarget.addEventListener(\"message\",n=>{t.consumeMessage(n.data,\"source\"in n&&n.source||null)}),!0}async executeWithSource(e,t,n,r){return await this.outboundMessage(t,e,n,r)}async execute(e,t=null,n=[]){return await this.outboundMessage(this.messageTarget,e,t,n)}outboundMessage(e,t,n=null,r=g){let a=this;return new Promise((o,l)=>{let x=this.idCount;a.queue.push({id:x,resolve:o,reject:l}),a.transferMessage(e,t,u,n,r)})}responseMessage(e,t,n){let r=typeof n==\"object\"&&n!==null&&n.__x_tdata__===!0;this.transferMessage(e,v,t,r?n.value:n,r?n.transferables:g)}errorResponseMessage(e,t,n){this.transferMessage(e,p,t,n)}transferMessage(e,t,n,r,a){let{messageContainer:o}=this,l=this.idCount++;return o.handle=t,o.respondingTo=n,o.data=r??null,o.id=l,(e||this.messageTarget).postMessage(o,a||g),l}async consumeMessage(e,t){if(e===null||typeof e!=\"object\"){console.warn(\"recieved message was not an object ignoring message\",e);return}if(e.handle===v||e.handle===p){let{queue:n}=this;for(let r=0;r<n.length;r++){let a=n[r];if(e.respondingTo===a.id){e.handle===p?a.reject(e.data):a.resolve(e.data),n.splice(r,1);return}}console.warn(\"incoming response doesn't map to any queued message. ignoring\",e);return}if(!this.actionsIndex.has(e.handle)){this.errorResponseMessage(t,e.id,`attempted to call non-existent handler \"${e.handle}\"`);return}if(e.respondingTo===u&&e.data!==void 0){let n=this.actionsIndex.get(e.handle);try{let r=await n(e.data,this.state)??null;this.responseMessage(t,e.id,r)}catch(r){this.errorResponseMessage(t,e.id,`rpc function \"${e.handle}\" encountered an exception. ${r} ${r?.stack||\"no-stack\"}`)}return}console.warn(\"incoming message is neither a response to a previous message or a request to perform an action. ignoring message\",e)}addResponses(e,{allowOverwrite:t=!1}={}){let n=Object.keys(e),r=!1;for(let a=0;a<n.length;a++){let o=n[a];!t&&this.actionsIndex.has(o)||(r=!0,this.actionsIndex.set(o,e[o]))}return r}};w(c,\"transfer\",E);var M=self,R={ping:(s,e)=>e.authToken},{top:y,addEventListener:S,removeEventListener:L}=M,m=()=>{},i=new c({responses:R,messageTarget:{postMessage:(s,e)=>{y.postMessage(s,\"*\",e)},addEventListener(s,e){m=t=>{t.source===y&&e({data:t.data})},S(\"message\",m)},removeEventListener(s,e){L(\"message\",m)}},state:{authToken:\"\"}}),_={getFile:async s=>{let e=await i.execute(\"getFile\",s);return e&&c.transfer(e,[e.body])}};var k=\"mirror-sw.compiled.js\";if(window.top!==window.parent)throw new Error(\"second-level embedding is disallowed\");if(window.self===window.top)throw new Error(\"document must be embedded in iframe\");if(!(\"serviceWorker\"in navigator))throw await i.execute(\"signalFatalError\",{extensionToken:\"\",details:\"Service worker not supported\"}),new Error(\"sandbox requires service worker to function\");var[C]=await Promise.all([navigator.serviceWorker.ready,navigator.serviceWorker.register(k)]),{active:W}=C,z=new c({responses:_,messageTarget:{postMessage(s,e){W?.postMessage(s,e)},addEventListener(s,e){navigator.serviceWorker.addEventListener(\"message\",e)},removeEventListener(s,e){navigator.serviceWorker.removeEventListener(\"message\",e)}},state:{}}),d=await i.execute(\"getInitialState\");if(!d)throw await i.execute(\"signalFatalError\",{extensionToken:\"\",details:`initial state is invalid, got ${d}`}),new Error(\"passed initial state was invalid\");i.state.authToken=d.authToken;var h=document.createElement(\"div\");h.setAttribute(\"id\",\"root\");document.body.appendChild(h);var F=[],I={rootElement:h,messageAppShell:(s,e=null,t=F)=>i.execute(s,e,t),initialState:d};await i.execute(\"secureContextEstablished\");var A=document.getElementById(\"root-script\"),f=await(async s=>{try{return console.info(\"importing\",s),await import(s)}catch(e){return console.error(\"encouintered error when importing module\",e),null}})(A?.getAttribute(\"entry\")||\"none\");if(!f)throw i.execute(\"signalFatalError\",{extensionToken:d.authToken,details:\"couldn't find extension entry\"}),new Error(\"extension entry does not exist\");if(!(\"main\"in f))throw i.execute(\"signalFatalError\",{extensionToken:d.authToken,details:\"'main' function is not exported from entry\"}),new Error(\"no main function exported from module\");var{main:O}=f;O(I);\n//# sourceMappingURL=secure.compiled.js.map\n"